node('master') {
    stage('Git clone'){
        git branch: 'task3', changelog: false, credentialsId: '301fa4a9-2eb7-4e10-8612-e23144ac7e24', poll: false, url: 'https://github.com/Ruksov-Andrey/training'}
    stage('copy clone') {
        sh ''' rm -rf /tmp/sptask3*
        cp -r -f /var/lib/jenkins/workspace/sptask3/ /tmp/sptask3/
        cd /tmp/sptask3'''}
    stage('Build') {
        sh '''cd /tmp/sptask3
        /opt/gradle/gradle-4.1/bin/gradle build'''}
    stage('Upload Nexus') {
    sh '''curl --upload-file /tmp/sptask3/build/libs/task3.war -u admin:admin123 -v http://localhost:8081/nexus/content/repositories/snapshots/task3/1.0.1/task3.war'''}
}
 
node('TOMCAT1') {
    stage('STOP TOMCAT1') {
        httpRequest responseHandle: 'NONE', url: 'http://172.20.20.12/jkmanager?cmd=update&from=list&w=lb&sw=tomcat1&vwa=1'}
        stage('Copy WAR in webapps') {
        sh '''rm /home/jenkins/workspace/sptask3/*
        wget http://172.20.20.12:8081/nexus/service/local/repositories/snapshots/content/task3/1.0.1/task3.war
        cp -f /home/jenkins/workspace/sptask3/task3.war /usr/share/tomcat/webapps'''}
    stage('VEREFY DEPLOY'){
        httpRequest httpMode: 'HEAD', responseHandle: 'NONE', url: 'http://127.0.0.1:8080/task3'}
    stage('START TOMCAT1'){
        httpRequest responseHandle: 'NONE', url: 'http://172.20.20.12/jkmanager?cmd=update&from=list&w=lb&sw=tomcat1&vwa=0'}
}

node('TOMCAT2') {
    stage('STOP TOMCAT2') {
        httpRequest responseHandle: 'NONE', url: 'http://172.20.20.12/jkmanager?cmd=update&from=list&w=lb&sw=tomcat2&vwa=1'}
        stage('Copy WAR in webapps') {
        sh '''rm /home/jenkins/workspace/sptask3/*
        wget http://172.20.20.12:8081/nexus/service/local/repositories/snapshots/content/task3/1.0.1/task3.war
        cp -f /home/jenkins/workspace/sptask3/task3.war /usr/share/tomcat/webapps'''}
    stage('VEREFY DEPLOY'){
        httpRequest httpMode: 'HEAD', responseHandle: 'NONE', url: 'http://127.0.0.1:8080/task3'}
    stage('START TOMCAT2'){
        httpRequest responseHandle: 'NONE', url: 'http://172.20.20.12/jkmanager?cmd=update&from=list&w=lb&sw=tomcat2&vwa=0'}


node('master') { 
    stage('push changes to task3 branch') {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: '73e1d50e-4849-4e0c-a465-ade566d14efc', usernameVariable: 'git_USERNAME', passwordVariable: 'git_PASSWORD']]){
        sh 'cd /tmp/sptask3/'
        sh 'git config --global user.name "Ruksov-Andrey"'
        sh 'git config --global user.email "theruksov@gmail.com"' 
        sh 'chmod 777 -R /tmp/sptask3/.git/'
        sh '''cd /tmp/sptask3/
        git add gradle.properties
        git add ./build/resources/main/greeting.txt
        git add ./build/libs/task3.war
        git commit -m 'increment version'
        git push https://${git_USERNAME}:${git_PASSWORD}@github.com/Ruksov-Andrey/training.git task3
        git checkout master
        git merge task3
        git tag release
        git push https://${git_USERNAME}:${git_PASSWORD}@github.com/Ruksov-Andrey/training.git master'''
        }
    }
}
